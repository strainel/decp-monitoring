---
title: "Données essentielles de la commande publique"
author: "MEF"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
---

```{r setup, include=FALSE}
require(flexdashboard)
require(plotly)
require(DT)
require(lubridate)
require(RColorBrewer)
load(file = "output/stats.Rdata")
labels <- c('aife' = "Aife / DUME", 'pes' = "DGFiP / PES marchés", 'emarchespublics' = "e-MarchésPublics",
            'grandlyon' = "Grand Lyon", 'marchespublicsinfo' = "MarchésPublics.info")
mycolors <- brewer.pal(n = 5, name = "Accent")
```

Dashboard {data-icon="fa-signal"}
=======================================================================

Row
-----------------------------------------------------------------------

### marchés publiés
```{r}
valueBox(sum(nbmarches$nb), icon = "ion-android-folder-open")
```

### marchés publiés les 10 derniers jours
```{r}
valueBox(sum(nbmarches$nb_10J), icon = "ion-ios-clock-outline")
```

### partenaires sans données depuis 10 jours
```{r}
nodata <- sum(nbmarches$nb_10J==0)
valueBox(nodata, icon = "ion-android-alert", 
         color=ifelse(nodata>1, "warning","primary"))
```

Row
-----------------------------------------------------------------------

### Evolution du nombre de marchés (DECP) par source
```{r}
y <- list(title = "nombre de marchés")
x <- list(title = "date de récupération des données",
          rangeselector = list(
            buttons = list(
              list(count = 1, label = '1 mois', step = 'month', stepmode = 'backward'),
              list(count = 3, label = '3 mois', step = 'month', stepmode = 'backward'),
              list(step = 'all', label = 'tout')
            )
          ),
          rangeslider = list(type = 'date'))
plot_ly(stats_cumul, x= ~date, y= ~aife, mode= 'lines', type='scatter', name = labels['aife'], 
        stackgroup = 1) %>%
  add_trace(y= ~marchespublicsinfo, name = labels['marchespublicsinfo']) %>%
  add_trace(y= ~pes, name = labels['pes']) %>%
  add_trace(y= ~emarchespublics, name = labels['emarchespublics']) %>%
  add_trace(y= ~grandlyon, name = labels['grandlyon']) %>%
  layout(yaxis=y, xaxis=x, autosize=T, hovermode="closest", legend=list(x=0.05, y=0.95), colorway = mycolors)
```

### Répartition des marchés par source
```{r}
df <- t(stats_cumul[nrow(stats_cumul),-1])
colnames(df) <- c('values')
df <- as.data.frame(df)
df$labels <- rownames(df)
df$labels <- labels[df$labels]
plot_ly(df, labels = ~labels, values = ~values, type = "pie", hole=0.6,
        textposition = 'inside', textinfo = 'label+percent', hoverinfo = 'text',
        text = ~paste(labels, ' : ', values, ' marchés transmis'), showlegend = FALSE) %>%
  layout(autosize=T, colorway = mycolors)
```


Données {data-icon="fa-table"}
=======================================================================

Tableau de comptage des marchés réceptionnés par jourtransmis par les différents partenaires

```{r}
stats2 <- stats2[order(rev(stats2$date)),]
colnames(stats2) <- c('Date', labels)
datatable(stats2, rownames = FALSE,  options = list(pageLength = 15))
```




Informations {data-icon="ion-information-circled"}
=======================================================================


### Les données essentielles de la commande publique


#### Objectifs

Ce tableau de bord permet de superviser le processus de construction des données essentielles de la commande publique. Chaque jour, des nouvelles données sont transmises par les différents partenaires. Elles sont consolidées et mises à disposition en *opendata*.


#### Hébergement
Ce tableau de bord est hébergé sur la plateforme GitHub.

Il est administré par l'équipe *Bercy Hub* de la délégation au système d'information (DSI) des ministères économiques et financiers, en lien avec les équipes de la [délégation aux affaires juridiques (DAJ)](https://www.economie.gouv.fr/daj).


#### Innovations ouvertes 

Les demandes d'amélioration  peuvent être soumises via une [*issue*](https://github.com/139bercy/decp-monitoring/issues).

Les développeurs peuvent également proposer des évolutions via une [*pull request*](https://github.com/139bercy/decp-monitoring/pulls).


### Partenaires
Un grand merci aux différentes équipes des partenaires qui publient leurs données sur les différents profils acheteurs.

```{r results='asis'}
for (i in 1:length(labels)) {
  cat("* ", labels[i], "\n")
}
```

Les partenaires qui souhaitent publier également leurs données sont invités à prendre contact auprès des [équipes de la DAJ](mailto:decp@finances.gouv.fr).